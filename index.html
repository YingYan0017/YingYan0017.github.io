<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Loloooo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Loloooo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="lolo">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Loloooo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Loloooo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">lolo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/19/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-%E7%BD%91%E5%85%B3-gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lolo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Loloooo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Loloooo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/19/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-%E7%BD%91%E5%85%B3-gateway/" class="post-title-link" itemprop="url">项目-网盘-网关-gateway</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-05-19 19:29:12 / 修改时间：19:51:13" itemprop="dateCreated datePublished" datetime="2024-05-19T19:29:12+08:00">2024-05-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="一-file-gateway-Tokenfilter"><a href="#一-file-gateway-Tokenfilter" class="headerlink" title="一 file-gateway&#x2F;Tokenfilter"></a>一 file-gateway&#x2F;Tokenfilter</h1><blockquote>
<p>这个是定义了一个pring Cloud Gateway 应用中的全局过滤器</p>
</blockquote>
<p><strong>用于拦截请求并验证请求中的 JWT 令牌。</strong></p>
<p>逐行注释下面的代码,一个token验证拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.quhailong.pan.file.gateway.filter;</span><br><span class="line"><span class="meta">@Component</span><span class="comment">//将这个类注册成Spring bean</span></span><br><span class="line"><span class="meta">@RefreshScope</span><span class="comment">// 允许在允许的时候刷新这个bean,通常用于动态更新配置属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;filter-url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String filterUrl;<span class="comment">// 从nacos读取</span></span><br><span class="line">    <span class="comment">//包含需要进行令牌验证的 URL 列表，从配置中注入</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();<span class="comment">//从exchange中获得当前请求的request</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getURI().getPath();<span class="comment">//从request中获得uri</span></span><br><span class="line">        List&lt;String&gt; uriList = Arrays.asList(filterUrl.split(<span class="string">&quot;,&quot;</span>));<span class="comment">//分割这个filterUrl，获取全部需要拦截的url列表</span></span><br><span class="line">        <span class="keyword">for</span> (String filterUrl:uriList) &#123;<span class="comment">///如果当前这个url需要被拦截，就拦截下来，验证token，如果有token，且正确，就可以放行</span></span><br><span class="line">            <span class="keyword">if</span>(uri.contains(filterUrl))&#123;</span><br><span class="line">                <span class="keyword">return</span> verifyToken(exchange, chain);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">// 这里就是验证token方法</span></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">verifyToken</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerHttpRequest request;<span class="comment">//尝试从请求的 Cookies 中获取名为 token 的令牌。</span></span><br><span class="line">            <span class="type">HttpCookie</span> <span class="variable">cookie</span> <span class="operator">=</span> exchange.getRequest().getCookies().getFirst(<span class="string">&quot;token&quot;</span>);<span class="comment">//获得token，返回类型是cookie类型</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> cookie.getValue();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//解析token（JWT）令牌，获得claim对象，这个对象是个啥。如果令牌失效就会返回错误的响应</span></span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JWTUtils.parseJWT(token, <span class="string">&quot;nimadetou&quot;</span>.getBytes());</span><br><span class="line">            <span class="comment">//从 Claims 中提取 subject 并将其转换为 UserInfoDTO 对象。</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">subject</span> <span class="operator">=</span> claims.getSubject();</span><br><span class="line">            <span class="type">UserInfoDTO</span> <span class="variable">userinfo</span> <span class="operator">=</span> JSONUtils.parseObject(subject, UserInfoDTO.class);</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//将编码后的用户信息添加到请求头中，继续处理请求。</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">operationInfo</span> <span class="operator">=</span> URLEncoder.encode(JSONUtils.toJSONString(userinfo), StandardCharsets.UTF_8.toString());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 把这个请求头放到request里面，然后继续向后面传递</span></span><br><span class="line">            request = exchange.getRequest().mutate().header(<span class="string">&quot;operationInfo&quot;</span>, operationInfo).build();</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange.mutate().request(request).build());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">            response.getHeaders().add(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="type">DataBuffer</span> <span class="variable">dataBuffer</span> <span class="operator">=</span> response.bufferFactory().wrap(JSON.toJSONString(RestAPIResultDTO.Error(<span class="string">&quot;token验证失败&quot;</span>)).getBytes());</span><br><span class="line">            <span class="keyword">return</span> response.writeWith(Flux.just(dataBuffer));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//返回过滤器的顺序，数值越小优先级越高。这里返回 0 表示最高优先级。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二-JWT"><a href="#二-JWT" class="headerlink" title="二 JWT"></a>二 JWT</h1><p>JWT（JSON Web Token）是一种用于在各方之间作为 JSON 对象安全传输信息的紧凑且自包含的方式。JWT 的使用场景包括身份验证、信息交换等。</p>
<h2 id="（1）JWT结构"><a href="#（1）JWT结构" class="headerlink" title="（1）JWT结构"></a>（1）JWT结构</h2><p>包含三个部分：Header（头部）、Payload（负载）、Signature（签名）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Header.Payload.Signature</span><br></pre></td></tr></table></figure>

<h3 id="1-头部"><a href="#1-头部" class="headerlink" title="1. 头部"></a>1. 头部</h3><blockquote>
<p>header通常包含两个部分，一个是令牌的类型（JWT）和签名算法（RSA,HMAC SH256）</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HS256&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;typ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JWT&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-Payload负载"><a href="#2-Payload负载" class="headerlink" title="2.Payload负载"></a>2.Payload负载</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/19/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8-Feign/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lolo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Loloooo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Loloooo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/19/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8-Feign/" class="post-title-link" itemprop="url">项目-网盘-远程调用-Feign</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-05-19 17:21:16 / 修改时间：18:52:04" itemprop="dateCreated datePublished" datetime="2024-05-19T17:21:16+08:00">2024-05-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">Java项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E9%A1%B9%E7%9B%AE/%E7%BD%91%E7%9B%98/" itemprop="url" rel="index"><span itemprop="name">网盘</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E9%A1%B9%E7%9B%AE/%E7%BD%91%E7%9B%98/%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8Feign/" itemprop="url" rel="index"><span itemprop="name">远程调用Feign</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="远程调用理论"><a href="#远程调用理论" class="headerlink" title="远程调用理论"></a>远程调用理论</h1><h2 id="一、远程调用方客户端"><a href="#一、远程调用方客户端" class="headerlink" title="一、远程调用方客户端"></a>一、远程调用方客户端</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;some-service&quot;)</span><span class="comment">// 这个指定了远程调用的服务名，一般是在服务注册中心中注册的服务吗</span></span><br><span class="line"><span class="comment">// 这个注释说明spring cloud feign要创建一个这个接口的代理实例，并将其用于名&quot;some-service&quot;发送远程服务的请求</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SomeServiceClient</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/some-endpoint&quot;)</span><span class="comment">//定义了一个get请求，目标是远程服务some-service的/some-endpoint 端点</span></span><br><span class="line">    ResponseEntity&lt;String&gt; <span class="title function_">getSomeData</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// 这个是feign客户端接口的方法的定义，也就是说，如果这个方法被调用了，那么就会把相应的请求转发到这个远程服务的端点上，、</span></span><br><span class="line">    <span class="comment">// 此外还定义了这个方法的响应，也就是ResponseEntity&lt;String&gt;，接受响应的结果</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="二、使用这个feign客户端的服务"><a href="#二、使用这个feign客户端的服务" class="headerlink" title="二、使用这个feign客户端的服务"></a>二、使用这个feign客户端的服务</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SomeOtherServiceController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SomeServiceClient someServiceClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/use-some-service&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">useSomeService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 调用远程服务的端点</span></span><br><span class="line">        <span class="comment">//这里就调用了一里面的客户端</span></span><br><span class="line">        <span class="keyword">return</span> someServiceClient.getSomeData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="三、被远程调用的服务名"><a href="#三、被远程调用的服务名" class="headerlink" title="三、被远程调用的服务名"></a>三、被远程调用的服务名</h2><p>按照上述的，远程调用的服务名“<strong>远程服务 <code>some-service</code></strong>:”</p>
<ul>
<li>这是注册在服务发现系统（如 Eureka）中的服务，<code>name = &quot;some-service&quot;</code> 对应它的服务名。</li>
<li><strong>它有一个暴露的 RESTful 端点 <code>/some-endpoint</code>，这个端点被 Feign 客户端所调用。</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SomeServiceController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/some-endpoint&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">getSomeData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 服务逻辑处理</span></span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="string">&quot;Some data from some-service&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><ul>
<li><code>SomeServiceClient</code> 是远程调用的客户端接口，通过 Feign 创建。</li>
<li><code>SomeServiceController</code> 中的 <code>/some-endpoint</code> 是被远程调用的端点。</li>
<li><code>useSomeService</code> 方法使用 Feign 客户端 <code>someServiceClient</code> 调用远程服务 <code>some-service</code> 的 <code>/some-endpoint</code>。</li>
</ul>
<p>在调用方法具体流程，浏览器在调用&#x2F;use-some-service的时候，被这个服务的消费者，也就是这个SomeOtherServiceController捕捉到，</p>
<p>在这个方法中，注入了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SomeServiceClient someServiceClient;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在具体这个<code>@GetMappping</code>方法中，会调用这个远程调用的客户端接口的对象，使用里面的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> someServiceClient.getSomeData();</span><br></pre></td></tr></table></figure>

<p>这个客户端方法里，会把这个方法的请求，转移发送到远程调用的服务端点那边去，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/some-endpoint&quot;)</span><span class="comment">//定义了一个get请求，目标是远程服务some-service的/some-endpoint 端点</span></span><br><span class="line">   ResponseEntity&lt;String&gt; <span class="title function_">getSomeData</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>发送到服务的some-endpoint端点上去</p>
<p>然后远程调用的服务提供者提供服务，返回数据</p>
<p>消费者得到返回的响应，形成一个对象</p>
<h1 id="openfeign的具体实现和理论"><a href="#openfeign的具体实现和理论" class="headerlink" title="openfeign的具体实现和理论"></a>openfeign的具体实现和理论</h1><h2 id="一、实现"><a href="#一、实现" class="headerlink" title="一、实现"></a>一、实现</h2><h3 id="1-pom-xml中添加依赖"><a href="#1-pom-xml中添加依赖" class="headerlink" title="1. pom.xml中添加依赖"></a>1. pom.xml中添加依赖</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-启动feign客户端，在启动类上使用-EnableFeignClients注释"><a href="#2-启动feign客户端，在启动类上使用-EnableFeignClients注释" class="headerlink" title="2.启动feign客户端，在启动类上使用@EnableFeignClients注释"></a>2.启动feign客户端，在启动类上使用<code>@EnableFeignClients</code>注释</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-定义Feign客户端接口"><a href="#3-定义Feign客户端接口" class="headerlink" title="3.定义Feign客户端接口"></a>3.定义Feign客户端接口</h3><p>使用 <code>@FeignClient</code> 注解定义一个接口来描述远程服务的 API。注解的 <code>name</code> 属性指定服务的名称，这个名称应该和服务注册中心（例如 Eureka）中的服务名一致。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;some-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SomeServiceClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/some-endpoint&quot;)</span></span><br><span class="line">    ResponseEntity&lt;String&gt; <span class="title function_">getSomeData</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/another-endpoint&quot;)</span></span><br><span class="line">    ResponseEntity&lt;String&gt; <span class="title function_">getAnotherData</span><span class="params">(<span class="meta">@RequestParam(&quot;param&quot;)</span> String param)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-使用这个feign客户端接口"><a href="#4-使用这个feign客户端接口" class="headerlink" title="4.使用这个feign客户端接口"></a>4.使用这个feign客户端接口</h3><p>就是在controller中调用这个feign客户端中的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SomeOtherServiceController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SomeServiceClient someServiceClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/use-some-service&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">useSomeService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 调用远程服务的端点</span></span><br><span class="line">        <span class="keyword">return</span> someServiceClient.getSomeData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/use-another-service&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">useAnotherService</span><span class="params">(<span class="meta">@RequestParam(&quot;param&quot;)</span> String param)</span> &#123;</span><br><span class="line">        <span class="comment">// 调用另一个远程服务的端点</span></span><br><span class="line">        <span class="keyword">return</span> someServiceClient.getAnotherData(param);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5.配置feign客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">  client:</span><br><span class="line">    config:</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        connectTimeout: <span class="number">5000</span></span><br><span class="line">        readTimeout: <span class="number">5000</span></span><br><span class="line">        loggerLevel: full</span><br></pre></td></tr></table></figure>

<p><strong>假设有一个名为 <code>some-service</code> 的微服务，它有两个端点 <code>/some-endpoint</code> 和 <code>/another-endpoint</code>，定义如下</strong></p>
<p><img src="/../blog_images/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8-Feign/image-20240519175609772.png" alt="image-20240519175609772"></p>
<h2 id="二、原理"><a href="#二、原理" class="headerlink" title="二、原理"></a>二、原理</h2><ul>
<li><strong>Feign Client</strong>：<code>@FeignClient</code> 注解用于定义 Feign 客户端，Spring Cloud Feign 会自动创建该接口的实现。</li>
<li><strong>负载均衡</strong>：如果启用了 Ribbon（默认情况），Feign 客户端将通过 Ribbon 实现负载均衡，选择合适的实例进行调用。</li>
<li><strong>Hystrix</strong>：Feign 还可以与 Hystrix 配合使用，实现熔断和回退机制。</li>
<li><strong>日志</strong>：通过配置 Feign 日志级别，可以记录详细的 HTTP 请求和响应。</li>
</ul>
<p>openfeign是一个声明式的HTTP客户端，简化了REST API的调用，底层涉及了非常多的组件，包括：</p>
<ul>
<li>动态代理</li>
<li>负载均衡</li>
<li>拦截器</li>
<li>……</li>
</ul>
<h3 id="1-动态代理"><a href="#1-动态代理" class="headerlink" title="1. 动态代理"></a>1. 动态代理</h3><p>按照之前介绍的,可以看到,声明的feign客户端其实是一个接口类,并不是一个实现类,</p>
<p><strong>所以,当定义一个feign客户端接口的时候,openfeign会创建这个接口的代理对象,在调用方法的时候,代理对象会拦截方法调用,然后将这个转化为HTTP请求</strong></p>
<p>a. 创建这个接口的代理对象,应该是cglib,</p>
<p>b.在调用方法的时候,这个代理对象会把这个方法的调用给拦截下来,</p>
<p>c.然后将这个方法转化为http的请求发送出去,到远程调用的远程服务提供者暴露的服务端点处</p>
<h3 id="2-核心组件"><a href="#2-核心组件" class="headerlink" title="2.核心组件"></a>2.核心组件</h3><h4 id="1-Feign-Builder-后续还需要学"><a href="#1-Feign-Builder-后续还需要学" class="headerlink" title="(1)Feign.Builder&#x2F;&#x2F; 后续还需要学"></a>(1)Feign.Builder&#x2F;&#x2F; 后续还需要学</h4><p>这个是创建feign客户端的核心类,是负责构造feign客户端实例,可以配置各种的选项,包括编码器,解码器,日志记录器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Feign.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> Feign.builder()</span><br><span class="line">                             .decoder(<span class="keyword">new</span> <span class="title class_">JacksonDecoder</span>())<span class="comment">//将 HTTP 响应解码为响应对象</span></span><br><span class="line">                             .encoder(<span class="keyword">new</span> <span class="title class_">JacksonEncoder</span>());<span class="comment">//将请求对象编码为 HTTP 请求</span></span><br><span class="line"><span class="type">SomeServiceClient</span> <span class="variable">client</span> <span class="operator">=</span> builder.target(SomeServiceClient.class, <span class="string">&quot;http://some-service&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>spring cloud feign默认使用spring的消息转换器(jackson)来处理编解码</p>
<h4 id="2-Contract"><a href="#2-Contract" class="headerlink" title="(2)Contract"></a>(2)Contract</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Contract 负责解析 Feign 客户端接口的注解。Spring Cloud Feign 使用 SpringMvcContract 来解析 Spring MVC 的注解，如 @RequestMapping、@GetMapping 等。</span><br></pre></td></tr></table></figure>

<h4 id="3-Client-是一个接口-负责执行HTTP请求"><a href="#3-Client-是一个接口-负责执行HTTP请求" class="headerlink" title="(3)Client&#x2F;&#x2F;是一个接口,负责执行HTTP请求."></a>(3)Client&#x2F;&#x2F;是一个接口,负责执行HTTP请求.</h4><p>就是一个HTTP的客户端,feign在builder的时候,可以选择使用Apache HttpClient 或 OkHttp\或者其他,然后利用这个客户端来实现执行HTTP的请求.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Client</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">Feign.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> Feign.builder().client(client);</span><br></pre></td></tr></table></figure>

<h4 id="4-Logger-用于记录请求和响应的日志"><a href="#4-Logger-用于记录请求和响应的日志" class="headerlink" title="(4)Logger,用于记录请求和响应的日志"></a>(4)Logger,用于记录请求和响应的日志</h4><p><img src="/../blog_images/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8-Feign/image-20240519182131701.png" alt="image-20240519182131701"></p>
<h3 id="三springcloud的组件"><a href="#三springcloud的组件" class="headerlink" title="三springcloud的组件"></a>三springcloud的组件</h3><h4 id="1-EnableFeignClients"><a href="#1-EnableFeignClients" class="headerlink" title="1. @EnableFeignClients"></a>1. @EnableFeignClients</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@EnableFeignClients</span><br><span class="line">这个注解启用了 Feign 客户端的自动配置。它会扫描指定包下的所有接口，并为每个接口创建一个 Feign 客户端代理。</span><br></pre></td></tr></table></figure>

<p>这个注释启用了feign的自动化配置,它会扫描指定包下面的所有的接口,为每个接口都创建一个feign的客户端代理,</p>
<h4 id="2-自动配置类"><a href="#2-自动配置类" class="headerlink" title="2.自动配置类"></a>2.自动配置类</h4><p>spring cloud feign提供了一些自动配置类,如 <code>FeignAutoConfiguration</code>、<code>FeignClientsConfiguration</code>.</p>
<p>这些配置类会自动的配置feign客户端所需要的各项组件.</p>
<h4 id="3-load-balance"><a href="#3-load-balance" class="headerlink" title="3.load balance"></a>3.load balance</h4><p>这个feign是默认集成了ribbon,用于客户端的负载均衡</p>
<p><img src="/../blog_images/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8-Feign/image-20240519183020401.png" alt="image-20240519183020401"></p>
<h4 id="4-Hystrix-整合"><a href="#4-Hystrix-整合" class="headerlink" title="4.Hystrix 整合"></a>4.Hystrix 整合</h4><p>Feign 与 Hystrix 整合，可以实现熔断和回退机制。通过在配置中启用 Hystrix，Feign 客户端在调用失败时可以自动进行回退。</p>
<p><img src="/../blog_images/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8-Feign/image-20240519183310894.png" alt="image-20240519183310894"></p>
<h4 id="5-扩展"><a href="#5-扩展" class="headerlink" title="5.扩展"></a>5.扩展</h4><p><img src="/../blog_images/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8-Feign/image-20240519183321748.png" alt="image-20240519183321748"></p>
<h1 id="EnableFeignClients"><a href="#EnableFeignClients" class="headerlink" title="@EnableFeignClients"></a>@<code>EnableFeignClients</code></h1><h2 id="1-注释的声明"><a href="#1-注释的声明" class="headerlink" title="1.注释的声明"></a>1.注释的声明</h2><p><code>@EnableFeignClients</code> 注解定义在 <code>org.springframework.cloud.openfeign</code> 包中。它的主要功能是通过 <code>FeignClientsRegistrar</code> 来注册 Feign 客户端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Import(FeignClientsRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableFeignClients &#123;</span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    String[] basePackages() <span class="keyword">default</span> &#123;&#125;;<span class="comment">//指定要扫描的包。</span></span><br><span class="line">    Class&lt;?&gt;[] basePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;?&gt;[] defaultConfiguration() <span class="keyword">default</span> &#123;&#125;;<span class="comment">//指定默认的配置类。</span></span><br><span class="line">    Class&lt;?&gt;[] clients() <span class="keyword">default</span> &#123;&#125;;<span class="comment">//指定具体的 Feign 客户端类。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-FeignClientsRegistrar-的工作原理"><a href="#2-FeignClientsRegistrar-的工作原理" class="headerlink" title="2.FeignClientsRegistrar 的工作原理"></a>2.<code>FeignClientsRegistrar</code> 的工作原理</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FeignClientsRegistrar` 是一个 `ImportBeanDefinitionRegistrar</span><br></pre></td></tr></table></figure>

<p>作用是在spring的bean的定义注册阶段注册Feign客户端的相关Bean</p>
<h3 id="注册过程"><a href="#注册过程" class="headerlink" title="注册过程"></a>注册过程</h3><p>a. <strong>扫描Feign客户端接口</strong>:FeignClientsRegistrar会根据@<code>EnableFeignClients</code> 注释的属性,比如basePackages,扫描指定包中的所有接口</p>
<p>‘’这个basePackages中的接口是怎么定义的?</p>
<p>b.<strong>注册Feign客户端Bean</strong>:对于每一个扫描到的接口,<code>FeignClientsRegistrar</code> 会注册一个 <code>FeignClientFactoryBean</code>，它是一个工厂 Bean，负责创建 Feign 客户端的代理对象。</p>
<h1 id="自动配置类"><a href="#自动配置类" class="headerlink" title="自动配置类"></a>自动配置类</h1><blockquote>
<p>FeignAutoConfiguration<code>和</code>FeignClientsConfiguration</p>
</blockquote>
<h2 id="1-FeignAutoConfiguration"><a href="#1-FeignAutoConfiguration" class="headerlink" title="1.FeignAutoConfiguration"></a>1.FeignAutoConfiguration</h2><p><code>FeignAutoConfiguration</code> 负责配置 Feign 的核心组件，如 <code>Feign.Builder</code>、<code>Decoder</code>、<code>Encoder</code>、<code>Contract</code> 等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(Feign.class)</span></span><br><span class="line"><span class="meta">@Import(FeignClientsConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> Feign.Builder <span class="title function_">feignBuilder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Feign.builder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> Decoder <span class="title function_">feignDecoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OptionalDecoder</span>(<span class="keyword">new</span> <span class="title class_">ResponseEntityDecoder</span>(<span class="keyword">new</span> <span class="title class_">SpringDecoder</span>(<span class="built_in">this</span>.messageConverters)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> Encoder <span class="title function_">feignEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringEncoder</span>(<span class="built_in">this</span>.messageConverters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> Contract <span class="title function_">feignContract</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringMvcContract</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> Logger <span class="title function_">feignLogger</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Slf4jLogger</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-FeignClientsConfiguration"><a href="#2-FeignClientsConfiguration" class="headerlink" title="2.FeignClientsConfiguration"></a>2.FeignClientsConfiguration</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignClientsConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Decoder <span class="title function_">feignDecoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntityDecoder</span>(<span class="keyword">new</span> <span class="title class_">SpringDecoder</span>(messageConverters));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Encoder <span class="title function_">feignEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringEncoder</span>(messageConverters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Contract <span class="title function_">feignContract</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringMvcContract</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger <span class="title function_">feignLogger</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Slf4jLogger</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3-Feign客户端的创建"><a href="#3-Feign客户端的创建" class="headerlink" title="3.Feign客户端的创建"></a>3.Feign客户端的创建</h2><p>当Feign的客户端创建后,</p>
<ol>
<li>Spring会使用<code>FeignClientFacatoryBean</code>来创建代理对象.</li>
<li>把接口的方法调用,转发到feign生成的HTTP请求</li>
</ol>
<p><code>FeignClientFactoryBean</code> 是一个工厂 Bean，用于创建 Feign 客户端代理对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignClientFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Object&gt;, InitializingBean &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> feignContext.getInstance(<span class="built_in">this</span>.name, Feign.Builder.class)</span><br><span class="line">                           .target(<span class="built_in">this</span>.targetType, <span class="built_in">this</span>.url);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 初始化配置</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/19/Feign/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lolo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Loloooo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Loloooo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/19/Feign/" class="post-title-link" itemprop="url">Feign</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-19 17:20:13" itemprop="dateCreated datePublished" datetime="2024-05-19T17:20:13+08:00">2024-05-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/19/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-AOPredis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lolo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Loloooo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Loloooo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/19/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-AOPredis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="post-title-link" itemprop="url">项目-网盘-AOPredis分布式锁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-05-19 16:04:37 / 修改时间：17:02:07" itemprop="dateCreated datePublished" datetime="2024-05-19T16:04:37+08:00">2024-05-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">Java项目</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E9%A1%B9%E7%9B%AE/%E7%BD%91%E7%9B%98/" itemprop="url" rel="index"><span itemprop="name">网盘</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E9%A1%B9%E7%9B%AE/%E7%BD%91%E7%9B%98/AOP/" itemprop="url" rel="index"><span itemprop="name">AOP</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="项目AOP-幂等性"><a href="#项目AOP-幂等性" class="headerlink" title="项目AOP 幂等性"></a>项目AOP 幂等性</h1><p><strong>注意：是通过自定义注释实现的，在需要实现幂等性的方法上添加注释</strong></p>
<h2 id="一、准备"><a href="#一、准备" class="headerlink" title="一、准备"></a>一、准备</h2><ol>
<li>自定义注解 <code>@Idempotent</code>，用于标识需要幂等性控制的方法。</li>
</ol>
<p><img src="/../blog_images/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-AOPredis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/image-20240519161422839.png" alt="image-20240519161422839"></p>
<ol start="2">
<li>定义AOP切面类</li>
</ol>
<ul>
<li>使用 <code>@Aspect</code> 定义切面，拦截使用 <code>@Idempotent</code> 注解的方法，确保幂等性。</li>
</ul>
<p><img src="/../blog_images/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-AOPredis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/image-20240519161544023.png" alt="image-20240519161544023"></p>
<h2 id="二、调用"><a href="#二、调用" class="headerlink" title="二、调用"></a>二、调用</h2><h3 id="1-在需要幂等性的接口方法上使用这个注释"><a href="#1-在需要幂等性的接口方法上使用这个注释" class="headerlink" title="1.在需要幂等性的接口方法上使用这个注释"></a>1.在需要幂等性的接口方法上使用这个注释</h3><p><img src="/../blog_images/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-AOPredis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/image-20240519162009066.png" alt="image-20240519162009066"></p>
<h3 id="2-在应用启动的时候，spring会自动的扫描并注册aop切面类’-IdempotentAopHandler"><a href="#2-在应用启动的时候，spring会自动的扫描并注册aop切面类’-IdempotentAopHandler" class="headerlink" title="2.在应用启动的时候，spring会自动的扫描并注册aop切面类’**IdempotentAopHandler**"></a>2.在应用启动的时候，spring会自动的扫描并注册aop切面类’**<code>IdempotentAopHandler</code>**</h3><ul>
<li>当调用标记了 <code>@Idempotent</code> 注解的方法时，AOP 切面会拦截调用，检查 Redis 中是否存在锁，如果不存在则设置锁并执行方法，执行完毕后释放锁。</li>
</ul>
<h3 id="3-获取唯一的标识"><a href="#3-获取唯一的标识" class="headerlink" title="3.获取唯一的标识"></a>3.获取唯一的标识</h3><ul>
<li>从 <code>@Idempotent</code> 注解中获取 <code>uniqueIdentification</code>，结合当前用户的 Token 生成幂等性锁标识。</li>
</ul>
<h3 id="4-尝试获得锁"><a href="#4-尝试获得锁" class="headerlink" title="4.尝试获得锁"></a>4.尝试获得锁</h3><ol>
<li><ul>
<li>调用 <code>redisUtil.setIfAbsentEx</code> 方法尝试在 Redis 中设置一个带有过期时间的键，如果设置成功，则表示获取到锁。</li>
</ul>
</li>
</ol>
<h3 id="5-执行方法"><a href="#5-执行方法" class="headerlink" title="5.执行方法"></a>5.执行方法</h3><ul>
<li>获取锁成功后，执行目标方法。</li>
<li>如果方法执行过程中抛出异常，记录日志并抛出自定义异常。</li>
</ul>
<h3 id="6-释放锁："><a href="#6-释放锁：" class="headerlink" title="6.释放锁："></a>6.<strong>释放锁</strong>：</h3><ul>
<li>方法执行完毕后，无论是否成功，都会在 <code>finally</code> 块中删除 Redis 锁，确保锁被释放。</li>
</ul>
<h3 id="7-异常处理"><a href="#7-异常处理" class="headerlink" title="7.异常处理"></a>7.异常处理</h3><ul>
<li>如果未能获取到锁，抛出自定义异常，表示该方法在指定时间内不能重复执行。</li>
</ul>
<p>通过这种方式，可以确保方法在指定的时间窗口内只会执行一次，防止重复提交或重复调用，保证接口的幂等性。</p>
<h2 id="三、代码"><a href="#三、代码" class="headerlink" title="三、代码"></a>三、代码</h2><p>在代码里是在AOP切面编程中，使用了redis的分布式锁来实现最终一个结果，就是redis的操作的幂等性，这个redis只是我的猜测，保证在并发情况下只执行一次</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.quhailong.pan.framework.redis.core.idempotent.aop;</span><br><span class="line"><span class="meta">@Order(1)</span><span class="comment">// 设置切面的执行顺序，值越小优先级越高</span></span><br><span class="line"><span class="meta">@Aspect</span><span class="comment">//表明这个类是一个切面类</span></span><br><span class="line"><span class="meta">@Slf4j</span><span class="comment">//引入日志记录功能</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IdempotentAopHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置操作日志切入点 记录操作日志 在注解的位置切入代码</span></span><br><span class="line"><span class="comment">     <span class="doctag">@annotation</span>(top.quhailong.pan.framework.redis.core.idempotent.annotation.Idempotent) 标识将匹配，即，将会在所有标注了这个注释的方法拦截，并调用aop</span></span><br><span class="line"><span class="comment">     */</span> 			</span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(top.quhailong.pan.framework.redis.core.idempotent.annotation.Idempotent)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">IdempotentPointCut</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过定义切入点，环绕通知（@Around 注解标注的方法）可以使用该切入点来指定在哪些方法执行前后进行额外的处理。</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 环绕通知，接口幂等</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span>: quhailong</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span>: 2020/7/26</span></span><br><span class="line"><span class="comment">     * round定义了一个环绕通知,围绕切点定义的方法的前后</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里需要处理幂等性控制逻辑</span></span><br><span class="line">    <span class="comment">// 通过这个注释，知道要在哪里拦截，那么就通过反射得到被拦截的方法和它的注释信息，</span></span><br><span class="line">     <span class="comment">//MethodSignature signature = (MethodSignature) proceedingJoinPoint.getSignature();</span></span><br><span class="line">       </span><br><span class="line">    <span class="comment">//Method method = signature.getMethod();</span></span><br><span class="line">    <span class="comment">// 通过这个方式获得方法（被拦截的方法）</span></span><br><span class="line">    <span class="meta">@Around(&quot;IdempotentPointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">addIdempotent</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取方法签名。</span></span><br><span class="line"><span class="comment">//        MethodSignature 和 Method：通过反射获取被拦截的方法和其注解信息。</span></span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) proceedingJoinPoint.getSignature();</span><br><span class="line">        <span class="comment">// 获取切入点所在的方法，获得方法对象，签名里包含了</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> signature.getMethod();</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取操作 dempotent 注解：获取注解实例，并读取 uniqueIdentification 属性，用于生成唯一的幂等性锁标识。</span></span><br><span class="line">        <span class="comment">// 注解实例是 Java 中表示注解的对象。通过反射机制，可以在运行时获取这些注解实例，并读取注解中的属性值。以下是如何定义和使用自定义注解的示例：</span></span><br><span class="line">        <span class="type">Idempotent</span> <span class="variable">idempotent</span> <span class="operator">=</span> method.getAnnotation(Idempotent.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">uniqueIdentification</span> <span class="operator">=</span> idempotent.uniqueIdentification();</span><br><span class="line">        <span class="comment">//uniqueIdentification 是 @Idempotent 注解中的一个属性，通过注解实例可以访问该属性的值。</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment">//        idempotentLock：构建 Redis 锁的键，使用唯一标识符和当前用户的 Token。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">idempotentLock</span> <span class="operator">=</span> String.format(RedisConstants.IDEMPOTENT_LOCK, uniqueIdentification, TokenUtil.getToken());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        redisUtil.setIfAbsentEx( 尝试在redis中设置一个带有过期时间的键,如果设置成功,表示获得了锁</span></span><br><span class="line">        <span class="keyword">if</span> (redisUtil.setIfAbsentEx(idempotentLock, UUID.randomUUID().toString(), <span class="number">120</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result = proceedingJoinPoint.proceed();</span><br><span class="line"><span class="comment">//                proceedingJoinPoint.proceed()：执行目标方法。</span></span><br><span class="line"><span class="comment">//                这里就是分布式的关键,需要得到锁,不然就不给执行</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;业务处理出现异常&quot;</span>, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CustomException</span>(ResultCodeEnum.SERVICE_EXCEPTION.getCode(), ResultCodeEnum.SERVICE_EXCEPTION.getDesc());</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                redisUtil.delete(idempotentLock);</span><br><span class="line"><span class="comment">//                删除redis的锁</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CustomException</span>(ResultCodeEnum.IDEMPOTENT_LOCK_ERROR.getCode(), ResultCodeEnum.IDEMPOTENT_LOCK_ERROR.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、一些细节"><a href="#四、一些细节" class="headerlink" title="四、一些细节"></a>四、一些细节</h2><h3 id="方法签名"><a href="#方法签名" class="headerlink" title="方法签名"></a>方法签名</h3><p>方法签名是编程中描述一个方法的特征的方式，它标识方法的名称以及方法的参数的类型顺序，在java中，方法签名不包括方法的返回类型和访问修饰符，</p>
<p><img src="/../blog_images/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-AOPredis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/image-20240519164704389.png" alt="image-20240519164704389"></p>
<p><img src="/../blog_images/%E9%A1%B9%E7%9B%AE-%E7%BD%91%E7%9B%98-AOPredis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/image-20240519164717586.png" alt="image-20240519164717586"></p>
<p><strong>作用</strong></p>
<p>AOP框架中，就是可以通过方法签名来识别和拦截方法的调用</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/12/%E6%8E%A5%E5%8F%A3%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lolo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Loloooo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Loloooo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/12/%E6%8E%A5%E5%8F%A3%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">接口自动化测试</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-12 14:51:26" itemprop="dateCreated datePublished" datetime="2024-05-12T14:51:26+08:00">2024-05-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-13 12:49:26" itemprop="dateModified" datetime="2024-05-13T12:49:26+08:00">2024-05-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Postman测试"><a href="#Postman测试" class="headerlink" title="Postman测试"></a>Postman测试</h1><p>登录接口</p>
<h1 id="添加课程接口调试"><a href="#添加课程接口调试" class="headerlink" title="添加课程接口调试"></a>添加课程接口调试</h1><p>如何处理课程添加接口对于登录接口的依赖</p>
<p>需要登录成功，就要获得对应的token，并将这个信息伴随着添加 课程请求发送给系统</p>
<p><img src="/../blog_images/%E6%8E%A5%E5%8F%A3%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/image-20240512155423448.png" alt="image-20240512155423448"></p>
<h1 id="登录接口测试"><a href="#登录接口测试" class="headerlink" title="登录接口测试"></a>登录接口测试</h1><h2 id="接口用例设计思路"><a href="#接口用例设计思路" class="headerlink" title="接口用例设计思路"></a>接口用例设计思路</h2><h3 id=""><a href="#" class="headerlink" title=""></a><img src="/../blog_images/%E6%8E%A5%E5%8F%A3%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/image-20240513124926240.png" alt="image-20240513124926240"></h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/12/Test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lolo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Loloooo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Loloooo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/12/Test/" class="post-title-link" itemprop="url">Test</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-12 14:51:14" itemprop="dateCreated datePublished" datetime="2024-05-12T14:51:14+08:00">2024-05-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/11/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lolo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Loloooo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Loloooo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/11/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/" class="post-title-link" itemprop="url">Redis-高级篇0411</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-04-11 10:00:52" itemprop="dateCreated datePublished" datetime="2024-04-11T10:00:52+08:00">2024-04-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-04-12 12:39:34" itemprop="dateModified" datetime="2024-04-12T12:39:34+08:00">2024-04-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="redis实战"><a href="#redis实战" class="headerlink" title="redis实战"></a>redis实战</h1><p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240411193128461.png" alt="image-20240411193128461"></p>
<h2 id="添加redis缓存"><a href="#添加redis缓存" class="headerlink" title="添加redis缓存"></a>添加redis缓存</h2><p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412102006771.png" alt="image-20240412102006771"></p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412102223465.png" alt="image-20240412102223465"></p>
<h2 id="缓存更新策略–缓存和数据库的一致性"><a href="#缓存更新策略–缓存和数据库的一致性" class="headerlink" title="缓存更新策略–缓存和数据库的一致性"></a>缓存更新策略–缓存和数据库的一致性</h2><p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412103529937.png" alt="image-20240412103529937"></p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412103954487.png" alt="image-20240412103954487"></p>
<p>0.3一致性有问题：当缓存已经执行了上百次，但是还没有和数据库保持一致性，这就会导致缓存和数据库的不一致性</p>
<p>01 需要我们自己编码</p>
<p>好的</p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412105724009.png" alt="image-20240412105724009"></p>
<p>坏了</p>
<p>更新的太慢了，</p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412110151242.png" alt="image-20240412110151242"> </p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412111423835.png" alt="image-20240412111423835"></p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412113042390.png" alt="image-20240412113042390"></p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412113449619.png" alt="image-20240412113449619"></p>
<p>返回空值会设置ttl</p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412113513294.png" alt="image-20240412113513294"></p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412114143006.png" alt="image-20240412114143006"></p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412115029875.png" alt="image-20240412115029875"></p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412121157556.png" alt="image-20240412121157556"></p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412121644372.png" alt="image-20240412121644372"></p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412121705685.png" alt="image-20240412121705685"></p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412122228072.png" alt="image-20240412122228072"></p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%870411/image-20240412123933989.png" alt="image-20240412123933989"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/01/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lolo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Loloooo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Loloooo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/01/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/" class="post-title-link" itemprop="url">Redis-高级篇</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-04-01 23:07:17" itemprop="dateCreated datePublished" datetime="2024-04-01T23:07:17+08:00">2024-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-04-02 20:58:31" itemprop="dateModified" datetime="2024-04-02T20:58:31+08:00">2024-04-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="redis是单线程还是多线程"><a href="#redis是单线程还是多线程" class="headerlink" title="redis是单线程还是多线程"></a>redis是单线程还是多线程</h1><ol>
<li>在4之前是部分或者完全不支持多线程的,</li>
<li>版本4严格意义上也不是单线程,而是负责处理客户端请求的线程是单线程,但是开始加了一点多线程的东西(异步删除)</li>
<li>2020年5月版本的6和2022年的7,告别了大家印象中的单线程,用一种全新的多线程来解决问题</li>
</ol>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402094354324.png" alt="image-20240402094354324"></p>
<hr>
<h2 id="Redis是单线程"><a href="#Redis是单线程" class="headerlink" title="Redis是单线程?"></a>Redis是单线程?</h2><p>主要是指redis的网络IO和键值对读写是由一个线程来完成的,redis在处理客户端请求的时候包括获取(socket读), 解析,执行,内容返回(socket)写等都是由一个顺序串行的主线程处理,这就是所谓的单线程,这也是redis对外提供键值存储服务的主要流程.</p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402100232629.png" alt="image-20240402100232629"></p>
<p>但是Redis的其他功能,比如持久话RDB\AOF\异步删除,集群数据同步等待,其实是由额外的线程执行的 </p>
<p>redis命令工作线程是单线程的,但是对于整个Redis来说,是多线程的</p>
<h3 id="为什么在3-0之前要采用单线程"><a href="#为什么在3-0之前要采用单线程" class="headerlink" title="为什么在3.0之前要采用单线程?"></a>为什么在3.0之前要采用单线程?</h3><blockquote>
<p>单线程但是快的原因</p>
</blockquote>
<ul>
<li><p>基于内存操作,Redis的所有数据都存储在内存中,因此所有的运算级别都是内存级别的,他的性能比较高</p>
</li>
<li><p>数据结构简单:redis的数据结构是专门设计的,而这些简单的数据结构的查找和操作的时间大部分复杂度都是O(1),因此性能是比较高的</p>
</li>
<li><p>多路复用和非阻塞I&#x2F;O:redis使用I&#x2F;O多礼服用的功能来监听多个socket连接客户端,这样就可以使用一个线程来连接多个请求,减少线程切换带来的开销,同时也避免了i&#x2F;o阻塞的操作</p>
</li>
<li><p>避免了不必要的上下文切换和多线程竞争,这就省去了多线程切换带来的时间和性能上的小号,而且单线程不会导致死锁的问题.</p>
</li>
<li></li>
</ul>
<blockquote>
<p>采用单线程的原因</p>
</blockquote>
<p>Redis是基于内存操作的,因此他的瓶颈可能是机器的内存或者是网络的带宽而并非CPU,既然CPU不是瓶颈,自然就使用单线程的解决方案了,何况使用多线程会比较的麻烦.(但是从redi开始就开始支持多线程了,比如后台删除,备份等功能)</p>
<ul>
<li>使用单线程redis的开发和维护更加的简单,因为单线程模型方便开发和调试</li>
<li>即使使用单线程模型也并发的解决多客户端的请求,主要使用的是IO多路复用和非组设IO</li>
<li>对于Redis系统来说,主要的性能瓶颈是内存或者网络带宽并非CPU</li>
</ul>
<h2 id="为什么要加入多线程"><a href="#为什么要加入多线程" class="headerlink" title="为什么要加入多线程?"></a>为什么要加入多线程?</h2><p><strong>正常情况下使用del指令可以很快的删除数据,但是当被删除的key是一个非常大的对象的时候,例如包含了成千上万个元素的hash集合时,那么del指令就会导致redis主线程卡顿</strong></p>
<p>由于redis是单线程的, del bigkey…</p>
<p>等待了很久这个线程才会释放,类似加了一个synchronized的锁,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlink key</span><br></pre></td></tr></table></figure>

<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402103828121.png" alt="image-20240402103828121"></p>
<h2 id="Redis6-7-开始全面多线程"><a href="#Redis6-7-开始全面多线程" class="headerlink" title="Redis6&#x2F;7 开始全面多线程"></a>Redis6&#x2F;7 开始全面多线程</h2><p>随着网络硬件的性能提升,redis的性能瓶颈有时候会出现在网络的IO处理上,也就是单个主线程处理网络请求的速度跟不上底层网络硬件的速度.</p>
<h3 id="为了解决这个问题"><a href="#为了解决这个问题" class="headerlink" title="为了解决这个问题"></a>为了解决这个问题</h3><p>采用多个IO线程来处理网络的请求,提高网络请求处理的并行度</p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402105237690.png" alt="image-20240402105237690"></p>
<img src="../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402105910048.png" alt="image-20240402105910048" style="zoom:33%;" />

<h4 id="阶段一-服务端和客户端建立socket连接-并分配处理线程"><a href="#阶段一-服务端和客户端建立socket连接-并分配处理线程" class="headerlink" title="阶段一:服务端和客户端建立socket连接,并分配处理线程"></a>阶段一:服务端和客户端建立socket连接,并分配处理线程</h4><p>首先,主线程负责接受建立连接请求,当由客户端请求和实例建立socket连接时,主线程会创建和客户端的连接,并把socket放入全局等待队列中,然后主线程通过轮询的方法把socket连接分配给io线程</p>
<h4 id="阶段二-IO线程读取并解析请求"><a href="#阶段二-IO线程读取并解析请求" class="headerlink" title="阶段二:IO线程读取并解析请求"></a>阶段二:IO线程读取并解析请求</h4><p>主线程一旦把socket分配给IO线程,就会进入阻塞状态,等待IO线程完成客户端请求读取和解析,因为由多个IO线程在并行处理,所以这个过程很快就可以完成.</p>
<h4 id="阶段三-主线程执行请求操作"><a href="#阶段三-主线程执行请求操作" class="headerlink" title="阶段三:主线程执行请求操作"></a>阶段三:主线程执行请求操作</h4><p>等待IO线程解析完请求,主线程还是会以单线程的方式执行这些命令操作</p>
<h4 id="阶段四-IO线程回写Socket和主线程清空全局队列"><a href="#阶段四-IO线程回写Socket和主线程清空全局队列" class="headerlink" title="阶段四:IO线程回写Socket和主线程清空全局队列"></a>阶段四:IO线程回写Socket和主线程清空全局队列</h4><p>当主线程执行完请求操作之后,会把需要返回的结果写入缓冲区,然后主线程会阻塞等待IO线程,把这些结果回写到socket中,并返回给客户端,和IO线程读取和解析请求一样,IO线程会 写socket,也是有多个线程在并发执行,所以回写socket的速度也是很快的,等到IO线程会谢socket完毕,主线程会清空队列,等待数据库的后续请求.</p>
<h1 id="Unix网络编程中的五种IO模型"><a href="#Unix网络编程中的五种IO模型" class="headerlink" title="Unix网络编程中的五种IO模型"></a>Unix网络编程中的五种IO模型</h1><h2 id="Blocking-IO-阻塞IO"><a href="#Blocking-IO-阻塞IO" class="headerlink" title="Blocking IO 阻塞IO"></a>Blocking IO 阻塞IO</h2><h2 id="NoneBlocking-IO-非阻塞IO"><a href="#NoneBlocking-IO-非阻塞IO" class="headerlink" title="NoneBlocking IO 非阻塞IO"></a>NoneBlocking IO 非阻塞IO</h2><h2 id="IO-multiplexingIO多路复用"><a href="#IO-multiplexingIO多路复用" class="headerlink" title="IO multiplexingIO多路复用"></a>IO multiplexingIO多路复用</h2><p>一种同步的IO模型,实现<strong>一个线程</strong>监视<strong>多个文件句柄</strong>,**一旦某个文件句柄就绪,**就能够通知到对应的应用程序进行相应的读写操作,<strong>没有文件句柄就绪的时候</strong>,就会阻塞应用程序,从而释放CPU资源.</p>
<h3 id="I-O"><a href="#I-O" class="headerlink" title="I&#x2F;O:"></a>I&#x2F;O:</h3><p>网络I&#x2F;O,尤其在操作系统层面指数据在内核态与用户态之间的读写关系</p>
<h3 id="多路"><a href="#多路" class="headerlink" title="多路"></a><strong>多路</strong></h3><p><strong>多个客户端连接(连接就是套接字描述符,即socket或者channel)</strong></p>
<h3 id="复用"><a href="#复用" class="headerlink" title="复用"></a><strong>复用</strong></h3><p><strong>复用一个或者几个线程</strong></p>
<h3 id="IO多路复用"><a href="#IO多路复用" class="headerlink" title="IO多路复用"></a>IO多路复用</h3><p>也就是说一个或者一组线程处理多个TCP连接,使用单进程就能够实现同时处理多个客户端的连接,<strong>无需创造或者维护过多的进程&#x2F;线程</strong></p>
<blockquote>
<p>一个服务端进程可以同时处理多个socket描述符</p>
<p>实现IO多路复用的模型有三种,可以分为&#x3D;&#x3D;<strong>select-&gt;poll-&gt;epoll</strong>&#x3D;&#x3D;三个阶段来描述</p>
</blockquote>
<h2 id="signal-driven-IO-信号驱动IO"><a href="#signal-driven-IO-信号驱动IO" class="headerlink" title="signal driven IO  信号驱动IO"></a>signal driven IO  信号驱动IO</h2><h2 id="asynchronous-IO-异步IO"><a href="#asynchronous-IO-异步IO" class="headerlink" title="asynchronous IO 异步IO"></a>asynchronous IO 异步IO</h2><h2 id="file-descriptor"><a href="#file-descriptor" class="headerlink" title="file descriptor"></a>file descriptor</h2><p>文件描述符 file descriptor 是计算机科学中的一个术语,是一个用于表述指向文件的引用的抽象化概念.文件描述符在形式上是一个非负整数.<strong>实际上,它是一个索引值,指向内核为每一个进程所维护的该进程打开文件的记录表.</strong></p>
<p><strong>当程序打开一个现有文件或者创建一个新文件时,内核向进程返回一个文件描述符,在程序设计中,文件描述符这一概念往往只适用于Unix,Linux这样的操作系统.</strong></p>
<p>当socket连接的时候,返回一个fd</p>
<h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402170350161.png" alt="image-20240402170350161"></p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402170557188.png" alt="image-20240402170557188"></p>
<p>客户端请求服务端时,实际就是在服务端的socket文件中写入客户端对应的文件描述符,如果与多个客户端同时请求服务端,为每次请求分配一个线程,类似于每次来都new一个 如此就会比较耗费服务端的资源</p>
<p>因此我们只使用一个线程来监听多个文件描述符,这就是IO多路复用</p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402171459395.png" alt="image-20240402171459395"> </p>
<h2 id="Redis6-7"><a href="#Redis6-7" class="headerlink" title="Redis6-7"></a>Redis6-7</h2><p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402171733957.png" alt="image-20240402171733957"></p>
<p>redis7将所有的数据都放在内存里,内存的响应时长大概是100纳秒,对于小数据包,redis服务器可以处理8W到10W的QPS,这也是redis处理的季羡林,对于80%的公司来说,单线程的redis已经足够使用了.</p>
<p><strong>多线程默认是关闭的</strong>,如果要使用多线程功能,需要在redis.conf中完成两个设置,</p>
<img src="../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402172207532.png" alt="image-20240402172207532" style="zoom:25%;" />

<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402172348792.png" alt="image-20240402172348792"></p>
<h1 id="BIGKEY"><a href="#BIGKEY" class="headerlink" title="BIGKEY"></a>BIGKEY</h1><p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402172659202.png" alt="image-20240402172659202"></p>
<h2 id="为什么不能使用key-这个指令"><a href="#为什么不能使用key-这个指令" class="headerlink" title="为什么不能使用key * 这个指令"></a>为什么不能使用key * 这个指令</h2><p>key * 这个指令有致命的弊端,这个指令没有offset,limit参数,是要一次性吐出所有满足条件的key,由于redis是单线程的,其所有操作都是原子的,而keys算法是遍历算法,复杂度是O(n),如果实例中有千万级别以上的key,这个指令i聚会导致redis服务卡顿,所有读写redis的其他的指令都会被延后甚至会超时报错,可能会导致雪崩甚至是数据库宕机</p>
<blockquote>
<p>生产上限制keys *&#x2F;fulshdb&#x2F;flushall等危险命令以防止误删误用?</p>
</blockquote>
<img src="../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402174418542.png" alt="image-20240402174418542" style="zoom:25%;" />

<img src="../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402174533926.png" alt="image-20240402174533926" style="zoom:33%;" />

<h2 id="不用keys-怎么迭代呢"><a href="#不用keys-怎么迭代呢" class="headerlink" title="不用keys 怎么迭代呢"></a>不用keys 怎么迭代呢</h2><p>scan命令,类似于mysql limit 但是不完全相同</p>
<p>用于迭代数据库当中的数据库的健</p>
<img src="../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402175152842.png" alt="image-20240402175152842" style="zoom:33%;" />

<img src="../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402175345171.png" alt="image-20240402175345171" style="zoom:50%;" />

<h2 id="阿里云的开发规范"><a href="#阿里云的开发规范" class="headerlink" title="阿里云的开发规范"></a>阿里云的开发规范</h2><img src="../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402202143721.png" alt="image-20240402202143721" style="zoom:33%;" />

<h2 id="Bigkey定义"><a href="#Bigkey定义" class="headerlink" title="Bigkey定义"></a>Bigkey定义</h2><h3 id="String是value-最大512MB但是≥10kb就是bigkey了"><a href="#String是value-最大512MB但是≥10kb就是bigkey了" class="headerlink" title="&#x3D;&#x3D;String是value,最大512MB但是≥10kb就是bigkey了&#x3D;&#x3D;"></a>&#x3D;&#x3D;String是value,最大512MB但是≥10kb就是bigkey了&#x3D;&#x3D;</h3><h3 id="list-hash-set与zset-个数超过5000就是bigkey"><a href="#list-hash-set与zset-个数超过5000就是bigkey" class="headerlink" title="&#x3D;&#x3D;list\hash\set与zset,个数超过5000就是bigkey&#x3D;&#x3D;"></a>&#x3D;&#x3D;list\hash\set与zset,个数超过5000就是bigkey&#x3D;&#x3D;</h3><h3 id=""><a href="#" class="headerlink" title=""></a><img src="../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402202430812.png" alt="image-20240402202430812" style="zoom:33%;" /></h3><blockquote>
<p>按照上述的来看,可存放的大小要大得多,为什么只能存储5000个?</p>
</blockquote>
<h2 id="BigKey的危害"><a href="#BigKey的危害" class="headerlink" title="BigKey的危害"></a>BigKey的危害</h2><h3 id="内存不均-集群迁移困难"><a href="#内存不均-集群迁移困难" class="headerlink" title="内存不均,集群迁移困难"></a>内存不均,集群迁移困难</h3><h3 id="超时删除-大key删除作梗"><a href="#超时删除-大key删除作梗" class="headerlink" title="超时删除,大key删除作梗"></a>超时删除,大key删除作梗</h3><h3 id="网络流量阻塞"><a href="#网络流量阻塞" class="headerlink" title="网络流量阻塞"></a>网络流量阻塞</h3><h2 id="BigKey怎么产生的"><a href="#BigKey怎么产生的" class="headerlink" title="BigKey怎么产生的"></a>BigKey怎么产生的</h2><img src="../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402202751172.png" alt="image-20240402202751172" style="zoom:33%;" />

<p>redis-cli-bigkeys</p>
<p>memory usage 命令 计算所占的每个字节数</p>
<h2 id="怎么删除"><a href="#怎么删除" class="headerlink" title="怎么删除"></a>怎么删除</h2><p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402203649521.png" alt="image-20240402203649521"></p>
<p>非字符串的bigkey不要使用del删除,</p>
<p>渐进式删除就是慢慢删,一点点的把这个field给减小了.最后再删掉</p>
<h3 id="String-底层优化过-可用del-太大的可以用unlink"><a href="#String-底层优化过-可用del-太大的可以用unlink" class="headerlink" title="String  底层优化过,可用del,太大的可以用unlink"></a>String  底层优化过,可用del,太大的可以用unlink</h3><h3 id="hash-使用hscan-每次获取少量的field-value-再使用hdel删除每个field"><a href="#hash-使用hscan-每次获取少量的field-value-再使用hdel删除每个field" class="headerlink" title="hash 使用hscan 每次获取少量的field-value ,再使用hdel删除每个field"></a>hash 使用hscan 每次获取少量的field-value ,再使用hdel删除每个field</h3><p>hscan与hdel</p>
<p><img src="/../blog_images/Redis-%E9%AB%98%E7%BA%A7%E7%AF%87/image-20240402205831413.png" alt="image-20240402205831413"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/01/Redis-%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lolo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Loloooo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Loloooo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/01/Redis-%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">Redis-集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-04-01 21:31:35 / 修改时间：23:05:31" itemprop="dateCreated datePublished" datetime="2024-04-01T21:31:35+08:00">2024-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Redis集群"><a href="#Redis集群" class="headerlink" title="Redis集群"></a>Redis集群</h1><img src="../blog_images/Redis-%E9%9B%86%E7%BE%A4/image-20240401213935236.png" alt="image-20240401213935236" style="zoom:25%;" />

<blockquote>
<p>集群:由于数据量过大,单个master复制集难以承担,因此需要对多个复制集进行集群,形成水平扩展每个复制集只负责存储整个数据集的一部分,这就是redis的集群,其作用是提供在多个redis节点间共享数据的程序集</p>
</blockquote>
<p>考集群的算法和架构拓扑安装</p>
<p><img src="/../blog_images/Redis-%E9%9B%86%E7%BE%A4/image-20240401214301548.png" alt="image-20240401214301548"></p>
<p><strong>&#x3D;&#x3D;Redis集群是一个提供在多个Redis节点间共享数据的程序集&#x3D;&#x3D;</strong></p>
<p><strong>&#x3D;&#x3D;Redis集群可以支持多个Master&#x3D;&#x3D;</strong></p>
<h2 id="干什么"><a href="#干什么" class="headerlink" title="干什么"></a>干什么</h2><p><strong>redis集群支持多个Master,每个Master又可以挂载多个slave</strong></p>
<ul>
<li>读写分离</li>
<li>支持数据的高可用</li>
<li>支持海量数据的读写存储操作</li>
</ul>
<p><strong>由于cluster自带的故障转移机制,内置了高可用的支持,无需再去使用哨兵的功能</strong></p>
<p><strong>客户端与redis的节点连接,不再需要连接集群中的所有节点,只需要任意连接集群中的一个可用节点即可</strong></p>
<p><strong>槽位slot负责分配到各个物理服务节点,又对应的集群来负责维护节点,插槽和数据之间的关系.</strong></p>
<h1 id="集群算法-分片-槽位slot"><a href="#集群算法-分片-槽位slot" class="headerlink" title="集群算法 分片 槽位slot"></a>集群算法 分片 槽位slot</h1><h2 id="槽位slot"><a href="#槽位slot" class="headerlink" title="槽位slot"></a>槽位slot</h2><p>集群的密钥空间被分为16384个槽位,有效设置了16384个主节点的集群大小上限(但是建议,最大的节点大小约为1000个节点)</p>
<p>redis有16384个哈希槽,每个key通过CRC16校验后对16384取模来决定防止在哪个槽,集群的每个节点负责一部分hash槽.</p>
<img src="../blog_images/Redis-%E9%9B%86%E7%BE%A4/image-20240401220220448.png" alt="image-20240401220220448" style="zoom:33%;" />

<h2 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h2><h3 id="1-定义-使用redis集群时我们会将存储的数据分散到多台redis机器中-这称为分片"><a href="#1-定义-使用redis集群时我们会将存储的数据分散到多台redis机器中-这称为分片" class="headerlink" title="1. 定义:使用redis集群时我们会将存储的数据分散到多台redis机器中,这称为分片."></a>1. 定义:使用redis集群时我们会将存储的数据分散到多台redis机器中,这称为分片.</h3><blockquote>
<p>集群中的每个redis实例都被认为是整个数据的一个分片</p>
</blockquote>
<h3 id="2-如何找到给定key的一个分片"><a href="#2-如何找到给定key的一个分片" class="headerlink" title="2.如何找到给定key的一个分片"></a><strong>2.如何找到给定key的一个分片</strong></h3><blockquote>
<p>为了找到给定key的分片,我们对key进行CRC16(KEY)算法处理并通过对总分片数量取模.然后,<strong>使用确定性哈希函数</strong>,这意味着给定的key<strong>将多次始终映射到同一个分片</strong>,我们可以推断将来读取特定key的位置</p>
</blockquote>
<h2 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h2><p><img src="/../blog_images/Redis-%E9%9B%86%E7%BE%A4/image-20240401221138492.png" alt="image-20240401221138492"></p>
<h1 id="slot槽位映射-一般业界有三种解决方案"><a href="#slot槽位映射-一般业界有三种解决方案" class="headerlink" title="slot槽位映射,一般业界有三种解决方案"></a>slot槽位映射,一般业界有三种解决方案</h1><h2 id="redis集群分片之hash取余分区算法"><a href="#redis集群分片之hash取余分区算法" class="headerlink" title="redis集群分片之hash取余分区算法"></a>redis集群分片之hash取余分区算法</h2><img src="../blog_images/Redis-%E9%9B%86%E7%BE%A4/image-20240401221729042.png" alt="image-20240401221729042" >



<h2 id="一致性哈希"><a href="#一致性哈希" class="headerlink" title="一致性哈希"></a>一致性哈希</h2><img src="../blog_images/Redis-%E9%9B%86%E7%BE%A4/image-20240401223213985.png" alt="image-20240401223213985" style="zoom:25%;" />



<p>分布式缓存数据变更与映射问题,某个机器宕机了,分母的数量就改变了,自然取余就不可以了</p>
<h4 id="能干啥"><a href="#能干啥" class="headerlink" title="能干啥"></a>能干啥</h4><ul>
<li>提出了一致性hash解决方案</li>
<li>目的是当服务器个数发生变动时,尽量减少影响客户端到服务器的映射关系</li>
</ul>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><h4 id="算法构建一致性哈希环"><a href="#算法构建一致性哈希环" class="headerlink" title="算法构建一致性哈希环"></a>算法构建一致性哈希环</h4><img src="../blog_images/Redis-%E9%9B%86%E7%BE%A4/image-20240401223306047.png" alt="image-20240401223306047" style="zoom:25%;" /> 

<h4 id="服务器IP节点映射"><a href="#服务器IP节点映射" class="headerlink" title="服务器IP节点映射"></a>服务器IP节点映射</h4><p><img src="/../blog_images/Redis-%E9%9B%86%E7%BE%A4/image-20240401223600375.png" alt="image-20240401223600375"></p>
<h4 id="key落到服务器的落键规则"><a href="#key落到服务器的落键规则" class="headerlink" title="key落到服务器的落键规则"></a>key落到服务器的落键规则</h4><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><img src="../blog_images/Redis-%E9%9B%86%E7%BE%A4/image-20240401223814591.png" alt="image-20240401223814591" style="zoom:33%;" />

<p><img src="/../blog_images/Redis-%E9%9B%86%E7%BE%A4/image-20240401223833557.png" alt="image-20240401223833557"></p>
<h2 id="哈希槽分区"><a href="#哈希槽分区" class="headerlink" title="哈希槽分区"></a>哈希槽分区</h2><p><img src="/../blog_images/Redis-%E9%9B%86%E7%BE%A4/image-20240401224030139.png" alt="image-20240401224030139"></p>
<p><img src="/../blog_images/Redis-%E9%9B%86%E7%BE%A4/image-20240401224227090.png" alt=" "></p>
<p>一定要-c 这个指令是值用集群的形式来运行 ,</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/01/Redis-%E5%93%A8%E5%85%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lolo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Loloooo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Loloooo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/01/Redis-%E5%93%A8%E5%85%B5/" class="post-title-link" itemprop="url">Redis-哨兵</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-04-01 18:11:32" itemprop="dateCreated datePublished" datetime="2024-04-01T18:11:32+08:00">2024-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-04-06 19:47:05" itemprop="dateModified" datetime="2024-04-06T19:47:05+08:00">2024-04-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="哨兵sentinel"><a href="#哨兵sentinel" class="headerlink" title="哨兵sentinel"></a>哨兵sentinel</h1><p>吹哨人巡查监控后台master主机是否故障,如果故障了根据<strong>投票数</strong>自动将某一个从库换成新主库;</p>
<p>投票数写多少:?</p>
<p><strong>作用:无人值守运维</strong></p>
<p>监控redis运行状态,包括master和slave</p>
<p>当master down 机,能自动将slave切换成新master</p>
<h2 id="能干什么"><a href="#能干什么" class="headerlink" title="能干什么"></a>能干什么</h2><h3 id="主从监控"><a href="#主从监控" class="headerlink" title="主从监控"></a>主从监控</h3><p>监控主从redis库运行是否正常</p>
<h3 id="消息通知"><a href="#消息通知" class="headerlink" title="消息通知"></a>消息通知</h3><p>哨兵可以将故障转移的结果发送给客户端</p>
<h3 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h3><p>如果master异常,则会进行主从切换,将其中一个slave作为新的Master</p>
<h3 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h3><p>客户端通过连接哨兵来获得当前redis服务的主节点</p>
<p><img src="/../blog_images/Redis-%E5%93%A8%E5%85%B5/image-20240401190333439.png" alt="image-20240401190333439"></p>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><h2 id="重点参数项说明"><a href="#重点参数项说明" class="headerlink" title="重点参数项说明"></a>重点参数项说明</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span><br></pre></td></tr></table></figure>

<p>设置要监控的master服务器</p>
<p>quorum表示最少有几个哨兵 认可客观下线,同意故障迁移的法定票数</p>
<img src="../blog_images/Redis-%E5%93%A8%E5%85%B5/image-20240401201726993.png" alt="image-20240401201726993" style="zoom:33%;" />

<blockquote>
<p>quorum这个参数是进行客观下线的一个依据,意思是至少有quorum个sentinel认为这个master有故障,才会对这个master进行下线以及故障转移.因为有的时候,某个sentinel节点可能因为自身网络的原因,无法连接master,而此时master并没有出现故障,所以这就需要多个sentinel都一致认为该master有问题,才可以进行下一步操作,就保证了公平性和高可用.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel auth-pass &lt;master-name&gt; &lt;password&gt; </span><br></pre></td></tr></table></figure>

<p>master 设置了密码,连接master服务的密码</p>
<img src="../blog_images/Redis-%E5%93%A8%E5%85%B5/image-20240401202612382.png" alt=" " style="zoom:33%;" />  

<img src="../blog_images/Redis-%E5%93%A8%E5%85%B5/image-20240401202852489.png" alt="image-20240401202852489" style="zoom:33%;" />

<img src="../blog_images/Redis-%E5%93%A8%E5%85%B5/image-20240401203501054.png" alt="image-20240401203501054" style="zoom:25%;" />

<h2 id="运行流程和选举原理"><a href="#运行流程和选举原理" class="headerlink" title="运行流程和选举原理"></a>运行流程和选举原理</h2><p>当一个主从配置中的master失效之后,sentinel可以选举出一个新的master用于自动接替原master的工作,主从配置中的其他redis服务器自动指向新的master同步数据.一般建议sentinel采用奇数台</p>
<h2 id="运行流程-故障切换"><a href="#运行流程-故障切换" class="headerlink" title="运行流程,故障切换"></a>运行流程,故障切换</h2><img src="../blog_images/Redis-%E5%93%A8%E5%85%B5/image-20240401205758253.png" alt="image-20240401205758253" style="zoom:25%;" />

<h3 id="三个哨兵监控一主二从-正常运行中……"><a href="#三个哨兵监控一主二从-正常运行中……" class="headerlink" title="三个哨兵监控一主二从,正常运行中……"></a>三个哨兵监控一主二从,正常运行中……</h3><h3 id="SDown主观下线-Subjectively-Down"><a href="#SDown主观下线-Subjectively-Down" class="headerlink" title="SDown主观下线(Subjectively Down)"></a>SDown主观下线(Subjectively Down)</h3><ul>
<li>SDOWN(主观不可用)是单个sentinel自己主观上检测到的关于master的状态,从sentinel的角度来看,如果发送了ping心跳之后,在一定的时间里面没有收到合法的回复,就达到了SDOWN的条件.</li>
<li>sentinel配置文件中的down-after-milliseconds设置了判断主观下线的时间长度</li>
</ul>
<img src="../blog_images/Redis-%E5%93%A8%E5%85%B5/image-20240401210114847.png" alt="image-20240401210114847" style="zoom:25%;" />

<h3 id="ODOWN客观下线-Objectively-down"><a href="#ODOWN客观下线-Objectively-down" class="headerlink" title="ODOWN客观下线(Objectively down)"></a>ODOWN客观下线(Objectively down)</h3><p>ODOWN需要一定数量的sentinel,多个哨兵达成一致意见才能认为一个master客观上已经宕了</p>
<p><img src="/../blog_images/Redis-%E5%93%A8%E5%85%B5/image-20240401210306067.png" alt="image-20240401210306067"></p>
<h3 id="选举出领导者哨兵-哨兵中选出兵王-leader"><a href="#选举出领导者哨兵-哨兵中选出兵王-leader" class="headerlink" title="选举出领导者哨兵(哨兵中选出兵王)leader"></a>选举出领导者哨兵(哨兵中选出兵王)leader</h3><p>当主节点被判断客观下线以后,哥哥哨兵节点会协商,先选举出一个**&#x3D;&#x3D;领导者哨兵节点&#x3D;&#x3D;** 并由该领导者节点,也即被选举出的leader进行failover(故障迁移)</p>
<h4 id="哨兵leader如何选举的-Raft算法"><a href="#哨兵leader如何选举的-Raft算法" class="headerlink" title="哨兵leader如何选举的 Raft算法"></a>哨兵leader如何选举的 Raft算法</h4><p>基本思路:先到先得        ,</p>
<p><img src="/../blog_images/Redis-%E5%93%A8%E5%85%B5/image-20240406194705477.png" alt="image-20240406194705477"></p>
<p><strong>在一轮选举中,哨兵A向B发送成为领导者的申请,如果B没有同意过其他哨兵,就会同意A成为领导者</strong></p>
 <img src="../blog_images/Redis-%E5%93%A8%E5%85%B5/image-20240401211541666.png" alt="image-20240401211541666" style="zoom:25%;" />

<h3 id="由leader开始推动故障切换流程并选择一个新的master"><a href="#由leader开始推动故障切换流程并选择一个新的master" class="headerlink" title="由leader开始推动故障切换流程并选择一个新的master"></a>由leader开始推动故障切换流程并选择一个新的master</h3><p>某一个slave被选中成为一个新的master,规则如下:</p>
<blockquote>
<p>由于存在网络抖动,不见得每个slave都会有效的得到master的信息,replication 谁复制的多就选谁</p>
</blockquote>
<img src="../blog_images/Redis-%E5%93%A8%E5%85%B5/image-20240401212047065.png" alt="image-20240401212047065" style="zoom: 33%;" />

<img src="../blog_images/Redis-%E5%93%A8%E5%85%B5/image-20240401212224451.png" alt="image-20240401212224451" style="zoom:33%;" />

<h4 id="执行slaveof-no-one命令让选出来的从节点成为新的主节点-并通过slaveof命令让其他节点成为其从节点"><a href="#执行slaveof-no-one命令让选出来的从节点成为新的主节点-并通过slaveof命令让其他节点成为其从节点" class="headerlink" title="执行slaveof no one命令让选出来的从节点成为新的主节点,并通过slaveof命令让其他节点成为其从节点"></a>执行slaveof no one命令让选出来的从节点成为新的主节点,并通过slaveof命令让其他节点成为其从节点</h4><p>Sentinel leader会对选举出的新master执行slaveof no one 操作,将其提升为master节点</p>
<p>sentinel leader向其他slave发送命令,让剩余的slave成为新的master节点的slave</p>
<h1 id="哨兵使用建议"><a href="#哨兵使用建议" class="headerlink" title="哨兵使用建议"></a>哨兵使用建议</h1><ul>
<li>哨兵系欸但的数量应该为多个,哨兵本身应该集群,保证高可用</li>
<li>哨兵节点的数量应该是奇数</li>
<li>各个哨兵节点的配置应该是一致的.最好硬件一样</li>
<li>如果哨兵节点部署在Docker等容器里面,尤其是注意端口的正确映射</li>
<li>哨兵集群+主从复制,并不能保证数据的零丢失</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">lolo</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
